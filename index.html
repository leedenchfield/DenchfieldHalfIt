<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Denchfield Half-It Challenge!</title>
<style>
  /* === Basic & Dark Mode Styles === */
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: auto;
    background-color: white;
    color: black;
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark-mode {
    background-color: #111;
    color: #eee;
  }

  /* === Layout & Controls === */
  input, button, select, textarea {
    font-size: 1em;
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    cursor: pointer;
  }

  /* === Sections & spacing === */
  #playerSection, #commandSection, #gameArea, #scoreboard, #historyArea {
    margin-top: 20px;
  }

  /* === Player Buttons === */
  #playerButtons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .player-btn {
    padding: 8px 15px;
    background-color: #ccc;
    border: none;
    border-radius: 4px;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .player-btn.selected {
    background-color: #0044cc;
    color: white;
    font-weight: bold;
    box-shadow: 0 0 5px #0044cc;
  }

  /* === Challenge list === */
  #commandList {
    max-height: 180px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    background: #f9f9f9;
  }
  #commandList.hidden {
    display: none;
  }
  .command-item {
    padding: 6px 8px;
    border-bottom: 1px solid #ddd;
    position: relative;
  }
  .command-item:last-child {
    border-bottom: none;
  }
  .command-item .command-text {
    font-weight: normal;
  }
  .command-item.active {
    font-weight: bold;
    font-size: 1.3em;
    background-color: #d0eaff;
    border-radius: 4px;
  }
  .command-item .description {
    font-style: italic;
    font-size: 0.85em;
    color: #555;
  }
  .edit-btn, .delete-btn {
    position: absolute;
    right: 10px;
    top: 8px;
    font-size: 0.8em;
    padding: 2px 6px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  .edit-btn {
    background-color: #faa;
    right: 45px;
  }
  .delete-btn {
    background-color: #fcc;
  }

  /* === Scoreboard === */
  #scoreboard {
    background: #eef;
    padding: 10px;
    border-radius: 5px;
  }
  #scoreboard ul {
    padding-left: 20px;
  }

  /* === History === */
  #historyArea {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 5px;
    background: #f4f4f4;
  }

  /* === Game Controls === */
  #gameControls {
    margin-top: 20px;
  }
  #gameControls > * {
    margin: 5px 0;
  }

  /* === Buttons styling === */
  #toggleCommandList, #darkModeToggle, #startGameBtn {
    background-color: #007acc;
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-weight: bold;
    width: auto;
    user-select: none;
  }
  #toggleCommandList:hover, #darkModeToggle:hover, #startGameBtn:hover {
    background-color: #005fa3;
  }

  /* === Hardcore toggle styling === */
  #hardcoreToggleLabel {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #hardcoreToggleLabel input {
    transform: scale(1.3);
  }

  /* === Mobile friendly adjustments === */
  @media (max-width: 600px) {
    body {
      padding: 10px;
      font-size: 16px;
    }
    #playerButtons {
      gap: 6px;
    }
    .player-btn {
      padding: 10px;
      font-size: 1.1em;
    }
    input, button, select {
      font-size: 1.1em;
      padding: 12px;
    }
  }
</style>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Dark Mode Toggle -->
  <button id="darkModeToggle">Toggle Dark Mode</button>

  <!-- Player Section -->
  <div id="playerSection">
    <h2>Players</h2>
    <div id="playerButtons"></div>
    <input id="newPlayerName" placeholder="Add new player name" />
    <button id="addPlayerBtn">Add Player</button>
  </div>

  <!-- Challenge List Toggle -->
  <button id="toggleCommandList">Toggle Challenge List</button>

  <!-- Challenge Section -->
  <div id="commandSection">
    <div id="commandList"></div>
    <input id="newCommandText" placeholder="New challenge text" />
    <input id="newCommandDesc" placeholder="Optional description" />
    <button id="addCommandBtn">Add Challenge</button>
  </div>

  <!-- Hardcore mode toggle -->
  <div id="hardcoreToggleContainer" style="margin-top:20px;">
    <label id="hardcoreToggleLabel">
      <input type="checkbox" id="hardcoreToggle" />
      Enable Hardcore Mode (one challenge per game)
    </label>
  </div>

  <!-- Number of rounds input -->
  <div id="roundsSection" style="margin-top:20px;">
    <label for="numRounds">Number of Challenges to Play:</label>
    <input type="number" id="numRounds" min="1" max="50" value="10" />
  </div>

  <!-- Game Controls -->
  <div id="gameControls" class="hidden">
    <div id="currentChallengeDisplay" class="command-item"></div>
    <div id="challengeDescription" style="font-style: italic; color: #555; margin-bottom: 10px;"></div>
    <input type="number" id="scoreInput" placeholder="Enter your score or 0 if fail" min="0" />
    <button id="submitScoreBtn">Submit Score</button>
    <button id="failChallengeBtn">Fail Challenge</button>
    <button id="undoBtn">Undo Last Entry</button>
  </div>

  <!-- Scoreboard -->
  <div id="scoreboard">
    <h3>Scoreboard</h3>
    <ul id="scoreList"></ul>
  </div>

  <!-- History -->
  <div id="historyArea">
    <h3>Game History</h3>
    <ul id="historyList"></ul>
  </div>

  <!-- Start Game Button at bottom -->
  <button id="startGameBtn" style="margin-top: 30px;">Start Game</button>

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
    authDomain: "denchfield-half-it.firebaseapp.com",
    projectId: "denchfield-half-it",
    storageBucket: "denchfield-half-it.firebasestorage.app",
    messagingSenderId: "494344468882",
    appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
    measurementId: "G-ZQQM5PNWPV"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // State variables
  let players = [];
  let commands = [];
  let history = [];
  let gameStarted = false;
  let currentChallengeIndex = 0;
  let currentPlayerIndex = 0;
  let selectedPlayers = [];
  let hardcoreEnabled = false;
  let hardcoreChallengeIndex = -1;
  let roundsToPlay = 10;
  let undoStack = [];

  /* --- Utility to save/load to Firestore --- */
  async function savePlayers() {
    await db.collection("players").doc("playersDoc").set({ players });
  }
  async function loadPlayers() {
    const doc = await db.collection("players").doc("playersDoc").get();
    if (doc.exists) players = doc.data().players || [];
    renderPlayerButtons();
  }

  async function saveCommands() {
    await db.collection("commandsDoc").set({ commands });
  }
  async function loadCommands() {
    const doc = await db.collection("commandsDoc").get();
    if (doc.exists) commands = doc.data().commands || [];
    renderCommandList();
  }

  async function saveHistory() {
    await db.collection("history").doc("historyDoc").set({ history });
  }
  async function loadHistory() {
    const doc = await db.collection("history").doc("historyDoc").get();
    if (doc.exists) history = doc.data().history || [];
    renderHistory();
  }

  /* --- UI rendering --- */

  function renderPlayerButtons() {
    const container = document.getElementById("playerButtons");
    container.innerHTML = "";
    players.forEach((p, i) => {
      const btn = document.createElement("button");
      btn.textContent = p.name + (p.score !== undefined ? ` (${p.score})` : "");
      btn.className = "player-btn" + (selectedPlayers.includes(i) ? " selected" : "");
      btn.onclick = () => togglePlayerSelection(i);
      container.appendChild(btn);
    });
  }

  function togglePlayerSelection(index) {
    if (gameStarted) return; // no selection change during game
    if (selectedPlayers.includes(index)) {
      selectedPlayers = selectedPlayers.filter(i => i !== index);
    } else {
      selectedPlayers.push(index);
    }
    renderPlayerButtons();
  }

  function renderCommandList() {
    const container = document.getElementById("commandList");
    container.innerHTML = "";
    commands.forEach((cmd, i) => {
      const div = document.createElement("div");
      div.className = "command-item";
      if (i === currentChallengeIndex) div.classList.add("active");

      const textSpan = document.createElement("span");
      textSpan.className = "command-text";
      textSpan.textContent = cmd.text;
      div.appendChild(textSpan);

      if (cmd.description) {
        const descSpan = document.createElement("div");
        descSpan.className = "description";
        descSpan.textContent = cmd.description;
        div.appendChild(descSpan);
      }

      // Edit button
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.className = "edit-btn";
      editBtn.onclick = () => editCommand(i);
      div.appendChild(editBtn);

      // Delete button
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "delete-btn";
      deleteBtn.onclick = () => deleteCommand(i);
      div.appendChild(deleteBtn);

      container.appendChild(div);
    });
  }

  function renderHistory() {
    const container = document.getElementById("historyList");
    container.innerHTML = "";
    history.forEach(entry => {
      const li = document.createElement("li");
      li.textContent = `${entry.player}: ${entry.challenge} - Score: ${entry.score} ${entry.failed ? "(Failed)" : ""}`;
      container.appendChild(li);
    });
  }

  function renderScoreboard() {
    const ul = document.getElementById("scoreList");
    ul.innerHTML = "";
    players.forEach(p => {
      const li = document.createElement("li");
      li.textContent = `${p.name}: ${p.score || 0}`;
      ul.appendChild(li);
    });
  }

  /* --- Command editing --- */
  function editCommand(index) {
    const cmd = commands[index];
    const newText = prompt("Edit challenge text:", cmd.text);
    if (newText === null) return; // cancelled
    const newDesc = prompt("Edit description:", cmd.description || "");
    commands[index] = { text: newText.trim(), description: newDesc.trim() };
    saveCommands();
    renderCommandList();
  }

  function deleteCommand(index) {
    if (!confirm("Delete this challenge?")) return;
    commands.splice(index, 1);
    saveCommands();
    renderCommandList();
  }

  /* --- Adding new player --- */
  document.getElementById("addPlayerBtn").onclick = () => {
    const nameInput = document.getElementById("newPlayerName");
    const name = nameInput.value.trim();
    if (!name) return alert("Player name cannot be empty");
    if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) return alert("Player already exists");
    players.push({ name, score: 0 });
    savePlayers();
    renderPlayerButtons();
    nameInput.value = "";
  };

  /* --- Adding new command --- */
  document.getElementById("addCommandBtn").onclick = () => {
    const textInput = document.getElementById("newCommandText");
    const descInput = document.getElementById("newCommandDesc");
    const text = textInput.value.trim();
    const desc = descInput.value.trim();
    if (!text) return alert("Challenge text cannot be empty");
    commands.push({ text, description: desc });
    saveCommands();
    renderCommandList();
    textInput.value = "";
    descInput.value = "";
  };

  /* --- Toggle Challenge List visibility --- */
  document.getElementById("toggleCommandList").onclick = () => {
    document.getElementById("commandList").classList.toggle("hidden");
  };

  /* --- Dark Mode toggle --- */
  document.getElementById("darkModeToggle").onclick = () => {
    document.body.classList.toggle("dark-mode");
  };

  /* --- Hardcore mode toggle --- */
  document.getElementById("hardcoreToggle").onchange = (e) => {
    hardcoreEnabled = e.target.checked;
  };

  /* --- Number of rounds input --- */
  document.getElementById("numRounds").onchange = (e) => {
    let val = parseInt(e.target.value, 10);
    if (isNaN(val) || val < 1) val = 1;
    roundsToPlay = val;
    e.target.value = val;
  };

  /* --- Game Start --- */
  document.getElementById("startGameBtn").onclick = () => {
    if (gameStarted) return alert("Game is already started!");
    if (selectedPlayers.length === 0) return alert("Select at least one player to start!");
    if (commands.length === 0) return alert("Add some challenges first!");

    // Reset scores & state
    players.forEach(p => p.score = 0);
    history = [];
    undoStack = [];

    currentChallengeIndex = 0;
    currentPlayerIndex = 0;

    // Hardcore challenge pick
    if (hardcoreEnabled) {
      hardcoreChallengeIndex = Math.floor(Math.random() * commands.length);
    } else {
      hardcoreChallengeIndex = -1;
    }

    gameStarted = true;
    document.getElementById("gameControls").classList.remove("hidden");
    updateCurrentChallengeDisplay();
    updateScores();
    renderHistory();
  };

  /* --- Update current challenge text --- */
  function updateCurrentChallengeDisplay() {
    const challengeDisplay = document.getElementById("currentChallengeDisplay");
    const challengeDesc = document.getElementById("challengeDescription");

    if (hardcoreEnabled) {
      const cmd = commands[hardcoreChallengeIndex];
      challengeDisplay.textContent = cmd.text;
      challengeDesc.textContent = cmd.description || "";
    } else {
      const cmd = commands[currentChallengeIndex];
      challengeDisplay.textContent = cmd.text;
      challengeDesc.textContent = cmd.description || "";
    }
  }

  /* --- Update scoreboard --- */
  function updateScores() {
    // Update player scores for selected players only
    selectedPlayers.forEach(idx => {
      if (players[idx].score === undefined) players[idx].score = 0;
    });
    renderScoreboard();
  }

  /* --- Submit score button --- */
  document.getElementById("submitScoreBtn").onclick = () => {
    if (!gameStarted) return alert("Start the game first!");
    const scoreInput = document.getElementById("scoreInput");
    const scoreVal = parseInt(scoreInput.value, 10);

    if (isNaN(scoreVal) || scoreVal < 0) {
      return alert("Please enter a valid score (0 or more)");
    }

    const playerIndex = selectedPlayers[currentPlayerIndex];
    const player = players[playerIndex];
    const challengeIndex = hardcoreEnabled ? hardcoreChallengeIndex : currentChallengeIndex;
    const challengeText = commands[challengeIndex].text;

    // Update player score
    player.score = (player.score || 0) + scoreVal;

    // Save history entry
    history.push({
      player: player.name,
      challenge: challengeText,
      score: scoreVal,
      failed: false,
      timestamp: Date.now()
    });
    undoStack.push({ type: "score", playerIndex, scoreVal });

    nextTurn();

    scoreInput.value = "";
    updateScores();
    renderHistory();
    savePlayers();
    saveHistory();
  };

  /* --- Fail challenge button --- */
  document.getElementById("failChallengeBtn").onclick = () => {
    if (!gameStarted) return alert("Start the game first!");

    const playerIndex = selectedPlayers[currentPlayerIndex];
    const player = players[playerIndex];
    const challengeIndex = hardcoreEnabled ? hardcoreChallengeIndex : currentChallengeIndex;
    const challengeText = commands[challengeIndex].text;

    // No score added, just history with failed flag
    history.push({
      player: player.name,
      challenge: challengeText,
      score: 0,
      failed: true,
      timestamp: Date.now()
    });
    undoStack.push({ type: "fail", playerIndex });

    nextTurn();
    updateScores();
    renderHistory();
    saveHistory();
  };

  /* --- Undo button --- */
  document.getElementById("undoBtn").onclick = () => {
    if (undoStack.length === 0) return alert("Nothing to undo");
    const lastAction = undoStack.pop();

    if (lastAction.type === "score") {
      const p = players[lastAction.playerIndex];
      p.score -= lastAction.scoreVal;
      history.pop();
    } else if (lastAction.type === "fail") {
      history.pop();
    }

    // Move back turn
    currentPlayerIndex--;
    if (currentPlayerIndex < 0) {
      currentPlayerIndex = selectedPlayers.length - 1;
      if (!hardcoreEnabled) {
        currentChallengeIndex--;
        if (currentChallengeIndex < 0) currentChallengeIndex = commands.length - 1;
      }
    }
    updateCurrentChallengeDisplay();
    updateScores();
    renderHistory();
    savePlayers();
    saveHistory();
  };

  /* --- Advance turn --- */
  function nextTurn() {
    // Advance player
    currentPlayerIndex++;
    if (currentPlayerIndex >= selectedPlayers.length) {
      currentPlayerIndex = 0;
      if (!hardcoreEnabled) {
        currentChallengeIndex++;
        if (currentChallengeIndex >= roundsToPlay) {
          alert("Game finished!");
          gameStarted = false;
          document.getElementById("gameControls").classList.add("hidden");
          return;
        }
      }
    }
    updateCurrentChallengeDisplay();
  }

  /* === Load initial data from Firestore === */
  loadPlayers();
  loadCommands();
  loadHistory();
</script>
</body>
</html>

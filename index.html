<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Denchfield Half-It Challenge!</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input, button, select, textarea { font-size: 1em; padding: 8px; margin: 5px 0; width: 100%; }
    #commandList, #gameArea, #historyArea, #playerButtons { margin-top: 20px; }
    .hidden { display: none; }
    .commandBox { font-size: 2em; margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; font-weight: bold; }
    .descriptionBox { font-size: 0.9em; margin: 10px 0; font-style: italic; }
    .score { font-size: 1.4em; margin: 10px 0; }
    #scoreboard { background: #eef; padding: 10px; margin-top: 10px; border-radius: 5px; }
    #scoreboard ul { padding-left: 20px; }
    .player-btn { margin: 5px; padding: 5px 10px; cursor: pointer; background-color: #ccc; border: none; border-radius: 4px; transition: 0.3s ease; }
    .player-btn.selected { background-color: #0044cc; color: white; font-weight: bold; box-shadow: 0 0 5px #0044cc; }
    .hardcore { color: red; font-weight: bold; }
    .edit-btn, .delete-btn { float: right; font-size: 0.8em; padding: 2px 6px; margin-left: 5px; border: none; border-radius: 3px; cursor: pointer; }
    .edit-btn { background-color: #faa; }
    .delete-btn { background-color: #fcc; }
    #toggleCommandList { margin-top: 10px; cursor: pointer; background: #ddd; border: none; padding: 5px 10px; border-radius: 5px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
      authDomain: "denchfield-half-it.firebaseapp.com",
      projectId: "denchfield-half-it",
      storageBucket: "denchfield-half-it.firebasestorage.app",
      messagingSenderId: "494344468882",
      appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
      measurementId: "G-ZQQM5PNWPV"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>
  <button id="toggleCommandList">Toggle Challenge List</button>
  <div id="commandList">
    <!-- Challenge list will populate here -->
  </div>

  <div id="setupArea">
    <input id="playerNameInput" placeholder="Enter player name" />
    <button onclick="addPlayer()">Add Player</button>
    <div id="playerButtons"></div>
    <input id="startingScore" type="number" placeholder="Starting score (default 0)" />
    <input id="numChallenges" type="number" placeholder="Number of challenges" />
    <label><input type="checkbox" id="enableHardcore" checked /> Enable Hardcore Challenge</label>
    <button onclick="startGame()">Start Game</button>
  </div>

  <div id="gameArea" class="hidden">
    <div class="commandBox" id="currentCommand"></div>
    <div class="descriptionBox" id="currentDescription"></div>
    <div id="scoreInputArea">
      <input id="scoreInput" placeholder="Enter score" type="number" />
      <button onclick="submitScore()">Submit Score</button>
      <button onclick="failChallenge()">Fail</button>
      <button onclick="undoLastAction()">Undo</button>
    </div>
    <div id="scoreboard"></div>
  </div>

  <div id="historyArea"></div>

  <script>
    let players = [];
    let selectedPlayers = [];
    let playerScores = {};
    let commands = [];
    let currentCommandIndex = 0;
    let round = 0;
    let currentPlayerIndex = 0;
    let gameStarted = false;
    let history = [];
    let hardcoreIndex = -1;
    let isHardcore = false;

    document.getElementById("toggleCommandList").onclick = () => {
      document.getElementById("commandList").classList.toggle("hidden");
    };

    function addPlayer() {
      const name = document.getElementById("playerNameInput").value.trim();
      if (!name || players.includes(name)) return;
      players.push(name);
      renderPlayerButtons();
      document.getElementById("playerNameInput").value = "";
    }

    function renderPlayerButtons() {
      const container = document.getElementById("playerButtons");
      container.innerHTML = "";
      players.forEach(p => {
        const btn = document.createElement("button");
        btn.textContent = p;
        btn.className = "player-btn";
        if (selectedPlayers.includes(p)) btn.classList.add("selected");
        btn.onclick = () => {
          if (selectedPlayers.includes(p)) {
            selectedPlayers = selectedPlayers.filter(n => n !== p);
          } else {
            selectedPlayers.push(p);
          }
          renderPlayerButtons();
        };
        container.appendChild(btn);
      });
    }

    function startGame() {
      if (selectedPlayers.length === 0) return alert("Select at least one player");
      const numChallenges = parseInt(document.getElementById("numChallenges").value);
      if (!numChallenges || numChallenges <= 0) return alert("Enter a valid number of challenges");
      const startingScore = parseInt(document.getElementById("startingScore").value) || 0;
      selectedPlayers.forEach(p => playerScores[p] = startingScore);
      round = 0;
      currentPlayerIndex = 0;
      gameStarted = true;
      hardcoreIndex = (document.getElementById("enableHardcore").checked && numChallenges >= 10) ? Math.floor(Math.random() * Math.floor(numChallenges / 10)) * 10 : -1;
      shuffle(commands);
      commands = commands.slice(0, numChallenges);
      document.getElementById("setupArea").classList.add("hidden");
      document.getElementById("gameArea").classList.remove("hidden");
      updateUI();
    }

    function updateUI() {
      const command = commands[round];
      isHardcore = (round === hardcoreIndex && document.getElementById("enableHardcore").checked);
      document.getElementById("currentCommand").textContent = command.text + (isHardcore ? " (Hardcore!)" : "");
      document.getElementById("currentCommand").classList.toggle("hardcore", isHardcore);
      document.getElementById("currentDescription").textContent = command.description || "";
      updateScoreboard();
    }

    function updateScoreboard() {
      const sb = document.getElementById("scoreboard");
      sb.innerHTML = "<h3>Scoreboard</h3><ul>" + selectedPlayers.map(p => `<li>${p}: ${playerScores[p]}</li>`).join("") + "</ul>";
    }

    function submitScore() {
      const score = parseInt(document.getElementById("scoreInput").value);
      if (isNaN(score)) return;
      const player = selectedPlayers[currentPlayerIndex];
      history.push({ player, score, round, wasFail: false, prevScore: playerScores[player] });
      playerScores[player] += score;
      nextTurn();
    }

    function failChallenge() {
      const player = selectedPlayers[currentPlayerIndex];
      history.push({ player, score: 0, round, wasFail: true, prevScore: playerScores[player] });
      playerScores[player] = isHardcore ? 0 : Math.ceil(playerScores[player] / 2);
      nextTurn();
    }

    function undoLastAction() {
      const last = history.pop();
      if (!last) return;
      playerScores[last.player] = last.prevScore;
      round = last.round;
      currentPlayerIndex = selectedPlayers.indexOf(last.player);
      updateUI();
    }

    function nextTurn() {
      currentPlayerIndex++;
      if (currentPlayerIndex >= selectedPlayers.length) {
        currentPlayerIndex = 0;
        round++;
        if (round >= commands.length) return endGame();
      }
      updateUI();
      document.getElementById("scoreInput").value = "";
    }

    function endGame() {
      const results = selectedPlayers.map(p => ({ name: p, score: playerScores[p] }))
        .sort((a, b) => b.score - a.score);
      document.getElementById("gameArea").innerHTML = `<h2>Game Over</h2><ul>${results.map(r => `<li>${r.name}: ${r.score}</li>`).join("")}</ul>`;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // Load commands from Firestore (placeholder)
    db.collection("commands").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        commands.push({ text: data.text, description: data.description || "" });
        const div = document.createElement("div");
        div.textContent = data.text;
        document.getElementById("commandList").appendChild(div);
      });
    });
  </script>
</body>
</html>

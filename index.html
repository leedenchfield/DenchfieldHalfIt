<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Denchfield Half-It Challenge!</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #111;
      color: #eee;
    }
    input, button, select, textarea {
      font-size: 1em;
      padding: 8px;
      margin:  5px 0;
      width: 100%;
      background-color: white;
      color: black;
    }
    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background-color: #222;
      color: white;
      border: 1px solid #555;
    }
    #commandList, #gameArea, #historyArea, #playerButtons {
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    .commandBox {
      font-size: 2em;
      margin: 15px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      font-weight: bold;
    }
    .descriptionBox {
      font-size: 0.9em;
      margin: 10px 0;
      font-style: italic;
    }
    .score {
      font-size: 1.4em;
      margin: 10px 0;
    }
    #scoreboard {
      background: #eef;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }
    #scoreboard ul {
      padding-left: 20px;
    }
    .player-btn {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #ccc;
      border: none;
      border-radius: 4px;
      transition: 0.3s ease;
    }
    .player-btn.selected {
      background-color: #0044cc;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 5px #0044cc;
    }
    .hardcore {
      color: red;
      font-weight: bold;
    }
    .edit-btn, .delete-btn {
      float: right;
      font-size: 0.8em;
      padding: 2px 6px;
      margin-left: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .edit-btn {
      background-color: #faa;
    }
    .delete-btn {
      background-color: #fcc;
    }
    #toggleCommandList {
      margin-top: 10px;
      cursor: pointer;
      background: #ddd;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
    }
    #darkModeToggle {
      margin: 10px 0;
      padding: 5px 10px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .action-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .action-buttons button {
      flex: 1;
    }
    #challengeDisplay {
      margin-top: 20px;
      padding: 10px;
      background-color: #e8f5e9;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #challengeDisplay h2 {
      font-size: 1.5em;
    }
    #challengeDisplay p {
      font-style: italic;
    }
    #turnDisplay {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 10px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <button id="darkModeToggle">Toggle Dark Mode</button>
  <h1>Denchfield Half-It Challenge!</h1>
  <div id="playerSection">
    <h2>Players</h2>
    <div id="playerButtons"></div>
    <input id="newPlayerName" placeholder="Enter player name" />
    <button onclick="addPlayer()">Add Player</button>
    <button onclick="startGame()">Start Game</button>
  </div>

  <div id="gameControls" class="hidden">
    <label>Total Challenges: <input type="number" id="numRounds" min="1" max="50" value="10" /></label>
    <label>Starting Score: <input type="number" id="startingScore" min="0" value="0" /></label>
    <div id="categorySettingsContainer" style="margin-top: 10px;">
      <h3>Select how many challenges from each category:</h3>
      <div id="categorySettings"></div>
    </div>
  </div>

  <button id="toggleCommandList">Toggle Challenge List</button>
  <div id="commandList"></div>
  <div>
    <input id="newCommandText" placeholder="New challenge text">
    <input id="newCommandDesc" placeholder="Optional description">
    <button onclick="addCommand()">Add Challenge</button>
  </div>

  <div id="scoreboard">
    <h3>Scoreboard</h3>
    <ul id="scoreList"></ul>
  </div>

  <div id="challengeDisplay" class="hidden">
    <h2 id="currentChallengeText"></h2>
    <p id="currentChallengeDesc"></p>
    <div id="turnDisplay"></div>
    <div class="action-buttons">
      <button onclick="submitScore()">Submit Score</button>
      <button onclick="failChallenge()">Fail</button>
      <button onclick="undoLastAction()">Undo</button>
    </div>
  </div>

  <div id="historyArea">
    <h3>Game History</h3>
    <ul id="historyList"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
      authDomain: "denchfield-half-it.firebaseapp.com",
      projectId: "denchfield-half-it",
      storageBucket: "denchfield-half-it.firebasestorage.app",
      messagingSenderId: "494344468882",
      appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
      measurementId: "G-ZQQM5PNWPV"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentChallenges = [];
    let currentChallengeIndex = 0;
    let players = [];
    let currentPlayerIndex = 0;
    let actionHistory = [];

    async function getSelectedChallenges() {
      const total = parseInt(document.getElementById("numRounds").value);
      const inputs = document.querySelectorAll(".category-count");
      const challengePool = [];
      let scoringPool = [], finishingPool = [];

      for (const input of inputs) {
        const count = parseInt(input.value || 0);
        const cat = input.dataset.category;
        if (count === 0) continue;
        const snap = await db.collection("commands").where("category", "==", cat).get();
        let cmds = [];
        snap.forEach(doc => cmds.push(doc.data()));
        cmds = cmds.sort(() => 0.5 - Math.random());
        const selected = cmds.slice(0, count);
        if (cat === "scoring") scoringPool = selected;
        else if (cat === "finishing") finishingPool = selected;
        else challengePool.push(...selected);
      }

      if (scoringPool.length === 0 || finishingPool.length === 0) {
        alert("Game must include at least one 'scoring' and one 'finishing' challenge.");
        return [];
      }

      const middleChallenges = challengePool.sort(() => 0.5 - Math.random());
      const result = [scoringPool[0], ...middleChallenges.slice(0, total - 2), finishingPool[0]];
      return result;
    }

    async function startGame() {
      currentChallenges = await getSelectedChallenges();
      if (!currentChallenges.length) return;
      currentChallengeIndex = 0;
      currentPlayerIndex = 0;
      document.getElementById("gameControls").classList.remove("hidden");
      document.getElementById("challengeDisplay").classList.remove("hidden");
      displayChallenge();
    }

    function displayChallenge() {
      const challenge = currentChallenges[currentChallengeIndex];
      if (!challenge) return;
      document.getElementById("currentChallengeText").textContent = challenge.text;
      document.getElementById("currentChallengeDesc").textContent = challenge.description || "";
      document.getElementById("turnDisplay").textContent = `Current Turn: ${players[currentPlayerIndex]?.name || "N/A"}`;
    }

    function submitScore() {
      const player = players[currentPlayerIndex];
      const oldScore = player.score;
      const score = prompt("Enter score for " + player.name);
      if (!score || isNaN(score)) return;
      player.score += parseInt(score);
      actionHistory.push({ playerIndex: currentPlayerIndex, oldScore });
      nextTurn();
    }

    function failChallenge() {
      const player = players[currentPlayerIndex];
      const oldScore = player.score;
      if (player.score > 1) {
        player.score = Math.max(1, Math.ceil(player.score / 2));
      }
      actionHistory.push({ playerIndex: currentPlayerIndex, oldScore });
      nextTurn();
    }

    function undoLastAction() {
      const last = actionHistory.pop();
      if (!last) return alert("No action to undo.");
      players[last.playerIndex].score = last.oldScore;
      currentPlayerIndex = last.playerIndex;
      displayChallenge();
      updateScoreboard();
    }

    function nextTurn() {
      currentPlayerIndex++;
      if (currentPlayerIndex >= players.length) {
        currentPlayerIndex = 0;
        currentChallengeIndex++;
      }
      if (currentChallengeIndex >= currentChallenges.length) {
        showGameSummary();
        return;
      }
      updateScoreboard();
      displayChallenge();
    }

    function showGameSummary() {
      let summary = "Game Over!\n\nFinal Scores:\n";
      const sorted = [...players].sort((a, b) => b.score - a.score);
      sorted.forEach(p => {
        summary += `${p.name}: ${p.score}\n`;
      });
      summary += `\nWinner: ${sorted[0].name}!`;
      alert(summary);
    }

    function updateScoreboard() {
      const scoreList = document.getElementById("scoreList");
      scoreList.innerHTML = "";
      players.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name}: ${p.score}`;
        scoreList.appendChild(li);
      });
    }
  </script>
</body>
</html>

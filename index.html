<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Denchfield Half-It Challenge!</title>
  <style>
    /* Basic reset */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 15px;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212;
      color: #eee;
    }
    button, input, select, textarea {
      font-size: 1em;
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      max-width: 300px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode button,
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #222;
      color: #eee;
      border: 1px solid #555;
    }
    button {
      cursor: pointer;
    }
    #playerButtons button,
    #playerButtons .player-btn {
      width: auto;
      display: inline-block;
      margin: 3px 5px 3px 0;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background-color: #ccc;
      color: black;
      font-weight: normal;
      transition: background-color 0.3s;
      position: relative;
    }
    #playerButtons button.selected {
      background-color: #0066cc;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 5px #0066cc;
    }
    .edit-btn, .delete-btn {
      font-size: 0.8em;
      padding: 2px 5px;
      margin-left: 6px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      position: absolute;
      top: 2px;
    }
    .edit-btn {
      right: 28px;
      background-color: #f9a825;
      color: black;
    }
    .delete-btn {
      right: 2px;
      background-color: #e53935;
      color: white;
    }
    #commandList {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      margin-top: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    body.dark-mode #commandList {
      background: #222;
      border-color: #555;
    }
    .command-item {
      margin-bottom: 8px;
      padding: 6px;
      border-radius: 4px;
      background: #eaeaea;
      position: relative;
    }
    body.dark-mode .command-item {
      background: #333;
    }
    .command-text {
      font-weight: normal;
    }
    .command-text.hardcore {
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.2em;
    }
    .command-desc {
      font-size: 0.9em;
      font-style: italic;
      margin-top: 2px;
      color: #555;
    }
    body.dark-mode .command-desc {
      color: #aaa;
    }
    #scoreboard {
      margin-top: 15px;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 5px;
      background: #eef;
    }
    body.dark-mode #scoreboard {
      background: #222;
      border-color: #555;
    }
    #scoreboard ul {
      list-style: none;
      padding-left: 10px;
      margin: 0;
    }
    #scoreboard li {
      margin-bottom: 4px;
      font-weight: bold;
    }
    #historyList {
      max-height: 150px;
      overflow-y: auto;
      margin-top: 15px;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
      background: #fafafa;
      font-size: 0.9em;
    }
    body.dark-mode #historyList {
      background: #111;
      border-color: #555;
      color: #ddd;
    }
    #gameArea {
      margin-top: 15px;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 5px;
      background: #fafafa;
    }
    body.dark-mode #gameArea {
      background: #222;
      border-color: #555;
    }
    #currentChallenge {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 6px;
    }
    #currentDescription {
      font-style: italic;
      margin-bottom: 12px;
      color: #555;
    }
    body.dark-mode #currentDescription {
      color: #bbb;
    }
    #confirmationOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #confirmationBox {
      background: white;
      padding: 20px;
      max-width: 90vw;
      border-radius: 8px;
      color: black;
    }
    body.dark-mode #confirmationBox {
      background: #222;
      color: #eee;
    }
    #confirmationBox h2 {
      margin-top: 0;
    }
    @media (max-width: 480px) {
      button, input, select, textarea {
        max-width: 100%;
      }
      #playerButtons button {
        padding: 6px 8px;
        margin: 3px 3px 3px 0;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <h1>Denchfield Half-It Challenge!</h1>

  <!-- Dark mode toggle -->
  <button id="darkModeToggle">Toggle Dark Mode</button>

  <!-- Player management -->
  <section id="playerSection">
    <h2>Players</h2>
    <div id="playerButtons" aria-live="polite" aria-label="Player list"></div>
    <input type="text" id="newPlayerName" placeholder="New player name" aria-label="New player name" />
    <button id="addPlayerBtn">Add Player</button>
  </section>

  <!-- Challenge management -->
  <section id="challengeSection">
    <h2>Challenges</h2>
    <button id="toggleCommandList">Show Challenge List</button>
    <div id="commandList" class="hidden" aria-live="polite" aria-label="Challenge list"></div>
    <input type="text" id="newCommandText" placeholder="New challenge text" aria-label="New challenge text" />
    <input type="text" id="newCommandDesc" placeholder="Optional description" aria-label="Challenge description" />
    <button id="addCommandBtn">Add Challenge</button>
  </section>

  <!-- Game settings -->
  <section id="gameSettings">
    <h2>Game Settings</h2>
    <label for="numChallengesInput">Number of challenges per round:</label>
    <input type="number" id="numChallengesInput" min="1" max="50" value="5" />
    <label><input type="checkbox" id="hardcoreToggle" /> Enable Hardcore Challenge Mode (once per game)</label>
    <button id="startGameBtn">Start Game</button>
  </section>

  <!-- Game play area -->
  <section id="gameArea" class="hidden" aria-live="polite" aria-label="Game area">
    <div id="currentChallenge"></div>
    <div id="currentDescription"></div>
    <label for="scoreInput">Score for current player:</label>
    <input type="number" id="scoreInput" placeholder="Enter score" aria-label="Score input" />
    <button id="submitScoreBtn">Submit Score</button>
    <button id="failChallengeBtn">Fail Challenge</button>
    <button id="undoBtn">Undo Last Action</button>
  </section>

  <!-- Scoreboard -->
  <section id="scoreboard" aria-live="polite" aria-label="Scoreboard">
    <h2>Scores</h2>
    <ul id="scoreList"></ul>
  </section>

  <!-- History -->
  <section id="history" aria-live="polite" aria-label="Game history">
    <h2>History</h2>
    <ul id="historyList"></ul>
  </section>

  <!-- Confirmation Modal -->
  <div id="confirmationOverlay" role="dialog" aria-modal="true" aria-labelledby="finalResults">
    <div id="confirmationBox">
      <h2>Game Over - Final Results</h2>
      <div id="finalResults"></div>
      <button id="closeConfirmationBtn">Close</button>
    </div>
  </div>

  <!-- Firebase App (Add your own config below) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    // --- Firebase Setup ---

    // REPLACE with your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
    authDomain: "denchfield-half-it.firebaseapp.com",
    projectId: "denchfield-half-it",
    storageBucket: "denchfield-half-it.firebasestorage.app",
    messagingSenderId: "494344468882",
    appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
    measurementId: "G-ZQQM5PNWPV"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- DOM Elements ---
    const playerButtonsDiv = document.getElementById('playerButtons');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const newPlayerNameInput = document.getElementById('newPlayerName');

    const commandListDiv = document.getElementById('commandList');
    const toggleCommandListBtn = document.getElementById('toggleCommandList');
    const addCommandBtn = document.getElementById('addCommandBtn');
    const newCommandTextInput = document.getElementById('newCommandText');
    const newCommandDescInput = document.getElementById('newCommandDesc');

    const numChallengesInput = document.getElementById('numChallengesInput');
    const hardcoreToggle = document.getElementById('hardcoreToggle');
    const startGameBtn = document.getElementById('startGameBtn');

    const gameArea = document.getElementById('gameArea');
    const currentChallengeDiv = document.getElementById('currentChallenge');
    const currentDescriptionDiv = document.getElementById('currentDescription');
    const scoreInput = document.getElementById('scoreInput');
    const submitScoreBtn = document.getElementById('submitScoreBtn');
    const failChallengeBtn = document.getElementById('failChallengeBtn');
    const undoBtn = document.getElementById('undoBtn');

    const scoreList = document.getElementById('scoreList');
    const historyList = document.getElementById('historyList');

    const darkModeToggleBtn = document.getElementById('darkModeToggle');

    const confirmationOverlay = document.getElementById('confirmationOverlay');
    const confirmationBox = document.getElementById('confirmationBox');
    const finalResultsDiv = document.getElementById('finalResults');
    const closeConfirmationBtn = document.getElementById('closeConfirmationBtn');

    // --- State ---
    let players = {}; // { playerId: { name, selected, score } }
    let challenges = {}; // { challengeId: { text, description, hardcore } }
    let gameStarted = false;
    let selectedPlayers = [];
    let numChallengesPerRound = 5;
    let hardcoreMode = false;

    // Game flow vars:
    let currentChallengeIndex = 0; // index in challengesToPlay array
    let currentPlayerIndex = 0; // index in selectedPlayers array
    let challengesToPlay = []; // array of challenge IDs randomized for the game
    let gameHistory = []; // array of {playerId, challengeId, score, failed}

    // Undo stack: store last action
    let undoStack = [];

    // --- Helpers ---

    function generateId() {
      return 'id-' + Math.random().toString(36).substr(2, 16);
    }

    // --- Load players from Firebase ---
    function loadPlayers() {
      db.ref('players').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        players = data;
        renderPlayers();
      });
    }

    // --- Render Players and selection buttons ---
    function renderPlayers() {
      playerButtonsDiv.innerHTML = '';
      selectedPlayers = [];

      for (const [id, p] of Object.entries(players)) {
        // Create player button
        const btn = document.createElement('button');
        btn.textContent = p.name;
        btn.className = p.selected ? 'selected' : '';
        btn.setAttribute('aria-pressed', p.selected ? 'true' : 'false');
        btn.classList.add('player-btn');
        btn.style.position = 'relative';

        // Toggle selection
        btn.onclick = () => {
          players[id].selected = !players[id].selected;
          db.ref('players/' + id + '/selected').set(players[id].selected);
        };

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.textContent = '✎';
        editBtn.className = 'edit-btn';
        editBtn.title = 'Edit player';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          const newName = prompt('Edit player name:', p.name);
          if (newName && newName.trim().length > 0) {
            db.ref('players/' + id + '/name').set(newName.trim());
          }
        };
        btn.appendChild(editBtn);

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = '🗑';
        delBtn.className = 'delete-btn';
        delBtn.title = 'Delete player';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Delete player "${p.name}"?`)) {
            db.ref('players/' + id).remove();
          }
        };
        btn.appendChild(delBtn);

        playerButtonsDiv.appendChild(btn);

        if (p.selected) {
          selectedPlayers.push(id);
        }
      }
    }

    // --- Add Player ---
    addPlayerBtn.onclick = () => {
      const name = newPlayerNameInput.value.trim();
      if (!name) {
        alert('Please enter a player name.');
        return;
      }
      // Save to Firebase with selected = false by default
      const newId = generateId();
      db.ref('players/' + newId).set({ name, selected: false, score: 0 });
      newPlayerNameInput.value = '';
    };

    // --- Load challenges ---
    function loadChallenges() {
      db.ref('challenges').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        challenges = data;
        renderChallenges();
      });
    }

    // --- Render Challenges ---
    function renderChallenges() {
      commandListDiv.innerHTML = '';
      for (const [id, c] of Object.entries(challenges)) {
        const div = document.createElement('div');
        div.className = 'command-item';
        // Challenge text, bold red if hardcore
        const textSpan = document.createElement('span');
        textSpan.textContent = c.text;
        textSpan.className = 'command-text' + (c.hardcore ? ' hardcore' : '');
        div.appendChild(textSpan);
        // Description if exists
        if (c.description) {
          const desc = document.createElement('div');
          desc.className = 'command-desc';
          desc.textContent = c.description;
          div.appendChild(desc);
        }

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.textContent = '✎';
        editBtn.className = 'edit-btn';
        editBtn.title = 'Edit challenge';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          const newText = prompt('Edit challenge text:', c.text);
          if (newText && newText.trim().length > 0) {
            db.ref('challenges/' + id + '/text').set(newText.trim());
          }
          const newDesc = prompt('Edit challenge description (optional):', c.description || '');
          db.ref('challenges/' + id + '/description').set(newDesc);
          const hardcore = confirm('Make this a hardcore challenge? OK = Yes, Cancel = No');
          db.ref('challenges/' + id + '/hardcore').set(hardcore);
        };
        div.appendChild(editBtn);

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = '🗑';
        delBtn.className = 'delete-btn';
        delBtn.title = 'Delete challenge';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Delete challenge "${c.text}"?`)) {
            db.ref('challenges/' + id).remove();
          }
        };
        div.appendChild(delBtn);

        commandListDiv.appendChild(div);
      }
    }

    // --- Add Challenge ---
    addCommandBtn.onclick = () => {
      const text = newCommandTextInput.value.trim();
      if (!text) {
        alert('Please enter challenge text.');
        return;
      }
      const description = newCommandDescInput.value.trim();
      const newId = generateId();
      db.ref('challenges/' + newId).set({ text, description, hardcore: false });
      newCommandTextInput.value = '';
      newCommandDescInput.value = '';
    };

    // --- Toggle challenge list ---
    toggleCommandListBtn.onclick = () => {
      if (commandListDiv.classList.contains('hidden')) {
        commandListDiv.classList.remove('hidden');
        toggleCommandListBtn.textContent = 'Hide Challenge List';
      } else {
        commandListDiv.classList.add('hidden');
        toggleCommandListBtn.textContent = 'Show Challenge List';
      }
    };

    // --- Dark mode toggle ---
    darkModeToggleBtn.onclick = () => {
      document.body.classList.toggle('dark-mode');
    };

    // --- Start Game ---
    startGameBtn.onclick = () => {
      if (gameStarted) {
        alert('Game already started!');
        return;
      }
      // Filter selected players
      selectedPlayers = Object.entries(players)
        .filter(([id, p]) => p.selected)
        .map(([id]) => id);

      if (selectedPlayers.length < 1) {
        alert('Please select at least one player to start.');
        return;
      }
      if (Object.keys(challenges).length < 1) {
        alert('Add some challenges first.');
        return;
      }

      numChallengesPerRound = parseInt(numChallengesInput.value);
      if (isNaN(numChallengesPerRound) || numChallengesPerRound < 1) {
        alert('Set a valid number of challenges per round.');
        return;
      }

      hardcoreMode = hardcoreToggle.checked;

      // Reset scores
      for (const pid of selectedPlayers) {
        players[pid].score = 0;
        db.ref('players/' + pid + '/score').set(0);
      }

      // Prepare challenges to play: shuffle challenges and pick number requested
      const challengeIds = Object.keys(challenges);
      challengesToPlay = shuffleArray(challengeIds).slice(0, numChallengesPerRound);

      currentChallengeIndex = 0;
      currentPlayerIndex = 0;
      gameHistory = [];
      undoStack = [];

      gameStarted = true;
      gameArea.classList.remove('hidden');
      startGameBtn.disabled = true;
      numChallengesInput.disabled = true;
      hardcoreToggle.disabled = true;

      updateScoreboard();
      showNextTurn();
    };

    // --- Utility: Shuffle ---
    function shuffleArray(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // --- Show next turn ---
    function showNextTurn() {
      if (!gameStarted) return;

      // Check if all challenges done
      if (currentChallengeIndex >= challengesToPlay.length) {
        endGame();
        return;
      }

      const challengeId = challengesToPlay[currentChallengeIndex];
      const challenge = challenges[challengeId];
      const playerId = selectedPlayers[currentPlayerIndex];
      const player = players[playerId];

      currentChallengeDiv.textContent = `Challenge: ${challenge.text}`;
      currentDescriptionDiv.textContent = challenge.description || '';
      scoreInput.value = '';
      scoreInput.focus();

      // Show player turn
      currentChallengeDiv.textContent = `Player: ${player.name} — Challenge: ${challenge.text}`;
    }

    // --- Submit score ---
    submitScoreBtn.onclick = () => {
      if (!gameStarted) return;
      const scoreVal = parseInt(scoreInput.value);
      if (isNaN(scoreVal) || scoreVal < 0) {
        alert('Enter a valid non-negative score.');
        return;
      }

      const challengeId = challengesToPlay[currentChallengeIndex];
      const playerId = selectedPlayers[currentPlayerIndex];
      const challenge = challenges[challengeId];

      // Update player's score
      players[playerId].score += scoreVal;
      db.ref('players/' + playerId + '/score').set(players[playerId].score);

      // Record history for undo
      gameHistory.push({ playerId, challengeId, score: scoreVal, failed: false });
      undoStack.push({ action: 'submitScore', playerId, challengeId, score: scoreVal });

      nextTurn();
    };

    // --- Fail challenge ---
    failChallengeBtn.onclick = () => {
      if (!gameStarted) return;

      const challengeId = challengesToPlay[currentChallengeIndex];
      const playerId = selectedPlayers[currentPlayerIndex];
      const challenge = challenges[challengeId];
      const player = players[playerId];

      if (challenge.hardcore) {
        // Reset player score to 0
        players[playerId].score = 0;
      } else {
        // Halve player score, rounded down
        players[playerId].score = Math.floor(players[playerId].score / 2);
      }
      db.ref('players/' + playerId + '/score').set(players[playerId].score);

      // Record history for undo
      gameHistory.push({ playerId, challengeId, score: 0, failed: true });
      undoStack.push({ action: 'failChallenge', playerId, challengeId });

      nextTurn();
    };

    // --- Next turn ---
    function nextTurn() {
      // Advance player index
      currentPlayerIndex++;
      if (currentPlayerIndex >= selectedPlayers.length) {
        currentPlayerIndex = 0;
        currentChallengeIndex++;
      }

      updateScoreboard();
      showNextTurn();
    }

    // --- Update scoreboard ---
    function updateScoreboard() {
      scoreList.innerHTML = '';
      selectedPlayers.forEach(pid => {
        const li = document.createElement('li');
        const p = players[pid];
        li.textContent = `${p.name}: ${p.score}`;
        scoreList.appendChild(li);
      });
    }

    // --- Undo last action ---
    undoBtn.onclick = () => {
      if (!undoStack.length) {
        alert('Nothing to undo!');
        return;
      }
      const lastAction = undoStack.pop();

      if (lastAction.action === 'submitScore') {
        // Revert score addition
        const p = players[lastAction.playerId];
        p.score -= lastAction.score;
        if (p.score < 0) p.score = 0;
        db.ref('players/' + lastAction.playerId + '/score').set(p.score);

        // Remove last history entry
        gameHistory.pop();

        // Go back one turn
        revertTurn();
      } else if (lastAction.action === 'failChallenge') {
        // We do not have previous score stored for fail, so we recalc from history
        // Undo fail means revert the score as before the fail
        // We can recompute scores from all previous history except last fail

        // Remove last fail history
        gameHistory.pop();

        // Reset all scores
        selectedPlayers.forEach(pid => {
          players[pid].score = 0;
        });
        // Replay all history except the last fail
        for (const entry of gameHistory) {
          if (!entry.failed) {
            players[entry.playerId].score += entry.score;
          } else {
            if (challenges[entry.challengeId].hardcore) {
              players[entry.playerId].score = 0;
            } else {
              players[entry.playerId].score = Math.floor(players[entry.playerId].score / 2);
            }
          }
        }
        // Update Firebase scores
        selectedPlayers.forEach(pid => {
          db.ref('players/' + pid + '/score').set(players[pid].score);
        });

        revertTurn();
      }
    };

    // --- Revert turn ---
    function revertTurn() {
      if (currentPlayerIndex === 0) {
        currentPlayerIndex = selectedPlayers.length - 1;
        currentChallengeIndex--;
        if (currentChallengeIndex < 0) currentChallengeIndex = 0;
      } else {
        currentPlayerIndex--;
      }
      updateScoreboard();
      showNextTurn();
    }

    // --- End game ---
    function endGame() {
      gameStarted = false;
      gameArea.classList.add('hidden');
      startGameBtn.disabled = false;
      numChallengesInput.disabled = false;
      hardcoreToggle.disabled = false;

      // Show final results
      finalResultsDiv.innerHTML = '';
      selectedPlayers.forEach(pid => {
        const p = players[pid];
        const div = document.createElement('div');
        div.textContent = `${p.name}: ${p.score}`;
        finalResultsDiv.appendChild(div);
      });

      confirmationOverlay.style.display = 'flex';
    }

    closeConfirmationBtn.onclick = () => {
      confirmationOverlay.style.display = 'none';
    };

    // --- Initial load ---
    loadPlayers();
    loadChallenges();
  </script>
</body>
</html>


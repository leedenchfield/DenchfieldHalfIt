<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Denchfield Half-It Challenge!</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    input, button, select, textarea {
      font-size: 1em;
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode input, body.dark-mode button, body.dark-mode select, body.dark-mode textarea {
      background-color: #333;
      color: #eee;
      border-color: #555;
    }
    button {
      cursor: pointer;
    }
    #commandList, #gameArea, #historyArea, #playerButtons {
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    .commandBox {
      font-size: 2em;
      margin: 15px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode .commandBox {
      background: #222;
    }
    .commandBox.current {
      font-weight: bold;
      font-size: 2.5em;
      color: #0044cc;
    }
    body.dark-mode .commandBox.current {
      color: #88caff;
    }
    .descriptionBox {
      font-size: 0.9em;
      margin: 10px 0;
      font-style: italic;
    }
    .score {
      font-size: 1.4em;
      margin: 10px 0;
    }
    #scoreboard {
      background: #eef;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode #scoreboard {
      background: #222;
    }
    #scoreboard ul {
      padding-left: 20px;
    }
    .player-btn {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #ccc;
      border: none;
      border-radius: 4px;
      transition: 0.3s ease;
      user-select: none;
    }
    .player-btn.selected {
      background-color: #0044cc;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 5px #0044cc;
    }
    .hardcore {
      color: red;
      font-weight: bold;
    }
    .edit-btn, .delete-btn {
      float: right;
      font-size: 0.8em;
      padding: 2px 6px;
      margin-left: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      user-select: none;
    }
    .edit-btn {
      background-color: #faa;
    }
    .delete-btn {
      background-color: #fcc;
    }
    #toggleCommandList {
      margin-top: 10px;
      cursor: pointer;
      background: #ddd;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      width: auto;
    }
    body.dark-mode #toggleCommandList {
      background: #444;
      color: #eee;
    }
    #darkModeToggle {
      margin-top: 10px;
      width: auto;
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
      background-color: #444;
      color: white;
      cursor: pointer;
    }
    body.dark-mode #darkModeToggle {
      background-color: #eee;
      color: #111;
    }
    #playersSection, #roundsSection, #gameArea, #commandControls {
      margin-top: 20px;
    }
    #gameArea button {
      width: auto;
      margin-right: 10px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Denchfield Half-It Challenge!</h1>

  <!-- Dark Mode Toggle -->
  <button id="darkModeToggle">Toggle Dark Mode</button>

  <!-- Players Section -->
  <div id="playersSection">
    <h2>Players</h2>
    <input id="newPlayerName" placeholder="Add player name" />
    <button onclick="addPlayer()">Add Player</button>
    <div id="playerButtons"></div>
  </div>

  <!-- Number of Rounds Input -->
  <div id="roundsSection">
    <label for="numRounds">Number of rounds to play:</label>
    <input type="number" id="numRounds" min="1" value="5" />
  </div>

  <!-- Starting Score Input -->
  <div id="startScoreSection">
    <label for="startScore">Starting score (default 0):</label>
    <input type="number" id="startScore" value="0" />
  </div>

  <!-- Start Game Button -->
  <div>
    <button id="startGameBtn" onclick="startGame()">Start Game</button>
  </div>

  <!-- Game Area -->
  <div id="gameArea" class="hidden">
    <div id="currentChallenge" class="commandBox"></div>
    <div id="challengeDescription" class="descriptionBox"></div>

    <div>
      <label for="scoreInput">Enter score or fail:</label>
      <input type="number" id="scoreInput" min="0" />
      <button onclick="submitScore()">Submit Score</button>
      <button onclick="failChallenge()">Fail</button>
      <button onclick="undoLast()">Undo</button>
    </div>

    <div id="scoreboard">
      <h3>Scoreboard</h3>
      <ul id="scoreList"></ul>
    </div>
  </div>

  <!-- Challenges Section -->
  <div id="challengesSection">
    <button id="toggleCommandList">Toggle Challenge List</button>
    <div id="commandList"></div>
    <div id="commandControls">
      <input id="newCommandText" placeholder="New challenge text" />
      <input id="newCommandDesc" placeholder="Optional description" />
      <button onclick="addCommand()">Add Challenge</button>
    </div>
  </div>

  <!-- Import Challenges -->
  <div style="margin-top:20px;">
    <h3>Import Challenges (JSON format)</h3>
    <textarea id="importChallengesInput" rows="6" style="width:100%;" placeholder='Paste challenges JSON here. Example: [{"text":"Challenge 1","description":"desc"},{"text":"Challenge 2"}]'></textarea>
    <button onclick="importChallenges()">Import Challenges</button>
  </div>

<script>
  // Firebase config and initialization
  const firebaseConfig = {
    apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
    authDomain: "denchfield-half-it.firebaseapp.com",
    projectId: "denchfield-half-it",
    storageBucket: "denchfield-half-it.firebasestorage.app",
    messagingSenderId: "494344468882",
    appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
    measurementId: "G-ZQQM5PNWPV"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // App State Variables
  let commands = [];
  let players = [];
  let selectedPlayers = [];
  let currentRound = 0;
  let numRounds = 5;
  let currentChallengeIndex = 0;
  let currentPlayerIndex = 0;
  let hardcoreUsed = false;
  let startScore = 0;
  let gameInProgress = false;

  // History for Undo: array of { playerIndex, roundIndex, challengeIndex, prevScore }
  let scoreHistory = [];

  // Load commands from Firebase and display
  function loadCommands() {
    commands = [];
    document.getElementById("commandList").innerHTML = "";
    db.collection("commands").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const cmd = { id: doc.id, text: data.text, description: data.description || "", hardcore: data.hardcore || false };
        commands.push(cmd);

        const div = document.createElement("div");
        div.className = "commandBox";
        div.textContent = cmd.text;
        if (cmd.description) {
          const desc = document.createElement("div");
          desc.className = "descriptionBox";
          desc.textContent = cmd.description;
          div.appendChild(desc);
        }

        // Edit button
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "edit-btn";
        editBtn.onclick = () => editCommand(cmd);

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = () => deleteCommand(cmd.id);

        div.appendChild(editBtn);
        div.appendChild(deleteBtn);

        document.getElementById("commandList").appendChild(div);
      });
    });
  }

  // Add a new command to Firebase
  function addCommand() {
    const text = document.getElementById("newCommandText").value.trim();
    const description = document.getElementById("newCommandDesc").value.trim();
    if (!text) return alert("Please enter a challenge text");
    db.collection("commands").add({ text, description }).then(() => {
      loadCommands();
      document.getElementById("newCommandText").value = "";
      document.getElementById("newCommandDesc").value = "";
    });
  }

  // Edit existing command
  function editCommand(cmd) {
    const newText = prompt("Edit challenge text:", cmd.text);
    if (newText === null) return;
    const newDesc = prompt("Edit description:", cmd.description);
    db.collection("commands").doc(cmd.id).set({ text: newText, description: newDesc || "" }).then(loadCommands);
  }

  // Delete a command
  function deleteCommand(id) {
    if (confirm("Delete this challenge?")) {
      db.collection("commands").doc(id).delete().then(loadCommands);
    }
  }

  // Player management
  function addPlayer() {
    const name = document.getElementById("newPlayerName").value.trim();
    if (!name) return alert("Enter player name");
    if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
      alert("Player already exists");
      return;
    }
    players.push({ name, score: 0 });
    updatePlayerButtons();
    document.getElementById("newPlayerName").value = "";
  }

  // Update player buttons
  function updatePlayerButtons() {
    const container = document.getElementById("playerButtons");
    container.innerHTML = "";
    players.forEach((p, i) => {
      const btn = document.createElement("button");
      btn.textContent = p.name;
      btn.className = "player-btn";
      if (selectedPlayers.includes(i)) btn.classList.add("selected");
      btn.onclick = () => {
        // Toggle selection
        const idx = selectedPlayers.indexOf(i);
        if (idx === -1) selectedPlayers.push(i);
        else selectedPlayers.splice(idx,1);
        updatePlayerButtons();
      };
      container.appendChild(btn);
    });
  }

  // Dark mode toggle
  document.getElementById("darkModeToggle").onclick = () => {
    document.body.classList.toggle("dark-mode");
  };

  // Toggle challenges list visibility
  document.getElementById("toggleCommandList").onclick = () => {
    document.getElementById("commandList").classList.toggle("hidden");
  };

  // Import challenges JSON
  function importChallenges() {
    const input = document.getElementById("importChallengesInput").value.trim();
    if (!input) return alert("Please paste JSON challenge data to import.");
    let challenges;
    try {
      challenges = JSON.parse(input);
    } catch (e) {
      return alert("Invalid JSON format. Please check your input.");
    }
    if (!Array.isArray(challenges)) return alert("JSON must be an array of challenge objects.");
    const validChallenges = challenges.filter(c => c.text && typeof c.text === "string");
    if (validChallenges.length === 0) return alert("No valid challenges found (each must have a 'text' property).");
    let addedCount = 0;
    validChallenges.forEach(challenge => {
      db.collection("commands").add({
        text: challenge.text,
        description: challenge.description || ""
      }).then(() => {
        addedCount++;
        if (addedCount === validChallenges.length) {
          alert(`${addedCount} challenges imported successfully.`);
          loadCommands();
          document.getElementById("importChallengesInput").value = "";
        }
      }).catch(err => {
        console.error("Error adding challenge:", err);
        alert("Some challenges could not be imported. Check console for details.");
      });
    });
  }

  // Initialize game state and UI
  function startGame() {
    if (selectedPlayers.length === 0) return alert("Select at least one player.");
    numRounds = parseInt(document.getElementById("numRounds").value);
    if (isNaN(numRounds) || numRounds < 1) return alert("Enter a valid number of rounds.");
    startScore = parseInt(document.getElementById("startScore").value);
    if (isNaN(startScore)) startScore = 0;

    // Initialize players scores
    selectedPlayers.forEach(i => players[i].score = startScore);

    if (commands.length < numRounds) {
      if (!confirm(`There are fewer challenges (${commands.length}) than rounds (${numRounds}). The challenges will loop.`)) {
        return;
      }
    }

    currentRound = 1;
    currentChallengeIndex = 0;
    currentPlayerIndex = 0;
    hardcoreUsed = false;
    scoreHistory = [];
    gameInProgress = true;

    document.getElementById("gameArea").classList.remove("hidden");
    document.getElementById("challengesSection").classList.add("hidden");
    document.getElementById("roundsSection").classList.add("hidden");
    document.getElementById("startScoreSection").classList.add("hidden");
    document.getElementById("startGameBtn").disabled = true;
    document.getElementById("playersSection").querySelectorAll("button, input").forEach(el => el.disabled = true);

    showNextChallenge();
    updateScoreboard();
  }

  // Show the current challenge and player
  function showNextChallenge() {
    if (!gameInProgress) return;
    if (currentRound > numRounds) {
      alert("Game over!");
      endGame();
      return;
    }

    const challenge = commands[currentChallengeIndex % commands.length];
    const playerIndex = selectedPlayers[currentPlayerIndex];
    const player = players[playerIndex];

    // Display challenge and player info
    const challengeBox = document.getElementById("currentChallenge");
    challengeBox.textContent = `Round ${currentRound} - ${player.name}: ${challenge.text}`;
    challengeBox.className = "commandBox current";
    if (challenge.hardcore) challengeBox.classList.add("hardcore");

    const descBox = document.getElementById("challengeDescription");
    descBox.textContent = challenge.description || "";

    // Clear score input
    document.getElementById("scoreInput").value = "";
  }

  // Submit score for current player/challenge
  function submitScore() {
    if (!gameInProgress) return;
    const input = document.getElementById("scoreInput").value;
    if (input === "") return alert("Enter a score or click Fail.");
    const score = parseInt(input);
    if (isNaN(score) || score < 0) return alert("Enter a valid non-negative score.");

    const challenge = commands[currentChallengeIndex % commands.length];
    const playerIndex = selectedPlayers[currentPlayerIndex];
    const player = players[playerIndex];

    // Save previous score for undo
    scoreHistory.push({
      playerIndex,
      round: currentRound,
      challengeIndex: currentChallengeIndex,
      prevScore: player.score
    });

    player.score += score;

    if (challenge.hardcore) hardcoreUsed = true;

    nextTurn();
  }

  // Fail challenge
  function failChallenge() {
    if (!gameInProgress) return;
    const challenge = commands[currentChallengeIndex % commands.length];
    const playerIndex = selectedPlayers[currentPlayerIndex];
    const player = players[playerIndex];

    scoreHistory.push({
      playerIndex,
      round: currentRound,
      challengeIndex: currentChallengeIndex,
      prevScore: player.score
    });

    // Half the score, round down
    player.score = Math.floor(player.score / 2);

    if (challenge.hardcore) hardcoreUsed = true;

    nextTurn();
  }

  // Undo last submitted score/fail
  function undoLast() {
    if (scoreHistory.length === 0) return alert("Nothing to undo.");
    const last = scoreHistory.pop();
    players[last.playerIndex].score = last.prevScore;

    // Reset currentRound, challenge, player indexes to the undone step
    currentRound = last.round;
    currentChallengeIndex = last.challengeIndex;
    currentPlayerIndex = selectedPlayers.indexOf(last.playerIndex);

    updateScoreboard();
    showNextChallenge();
  }

  // Advance to next player/challenge/round
  function nextTurn() {
    currentChallengeIndex++;
    currentPlayerIndex++;
    if (currentPlayerIndex >= selectedPlayers.length) {
      currentPlayerIndex = 0;
      currentRound++;
    }
    updateScoreboard();
    if (currentRound > numRounds) {
      alert("Game over!");
      endGame();
    } else {
      showNextChallenge();
    }
  }

  // Update scoreboard display
  function updateScoreboard() {
    const ul = document.getElementById("scoreList");
    ul.innerHTML = "";
    selectedPlayers.forEach(i => {
      const p = players[i];
      const li = document.createElement("li");
      li.textContent = `${p.name}: ${p.score}`;
      ul.appendChild(li);
    });
  }

  // End game cleanup
  function endGame() {
    gameInProgress = false;
    document.getElementById("gameArea").classList.add("hidden");
    document.getElementById("challengesSection").classList.remove("hidden");
    document.getElementById("roundsSection").classList.remove("hidden");
    document.getElementById("startScoreSection").classList.remove("hidden");
    document.getElementById("startGameBtn").disabled = false;
    document.getElementById("playersSection").querySelectorAll("button, input").forEach(el => el.disabled = false);
  }

  // Initial loading
  window.onload = () => {
    loadCommands();
    updatePlayerButtons();
  };
</script>
</body>
</html>

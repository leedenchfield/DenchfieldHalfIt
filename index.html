<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Denchfield Half-It Challenge!</title>
  <style>
    /* General body styling and max width */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background-color: white;
      color: black;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    /* Dark mode styles */
    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }
    /* Common input/button styles */
    input, button, select, textarea {
      font-size: 1em;
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    /* Smaller width for inline elements */
    input.inline, select.inline {
      width: auto;
      display: inline-block;
      margin-right: 10px;
    }
    /* Section containers */
    #commandList, #gameArea, #historyArea, #playerButtons, #playersSection, #challengesSection {
      margin-top: 20px;
    }
    /* Hide elements with this class */
    .hidden {
      display: none;
    }
    /* Highlight current challenge box */
    .commandBox {
      font-size: 2em;
      margin: 15px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    /* Dark mode styling for challenge box */
    body.dark .commandBox {
      background: #333;
    }
    /* Highlight the active/current challenge */
    .current {
      font-weight: 900;
      font-size: 2.5em;
      color: #0044cc;
    }
    /* Hardcore challenge styling */
    .hardcore {
      color: red;
      font-weight: bold;
    }
    /* Description below challenge text */
    .descriptionBox {
      font-size: 0.9em;
      margin: 10px 0;
      font-style: italic;
      min-height: 1.2em;
    }
    /* Score display font size */
    .score {
      font-size: 1.4em;
      margin: 10px 0;
    }
    /* Scoreboard styling */
    #scoreboard {
      background: #eef;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }
    body.dark #scoreboard {
      background: #222;
    }
    /* List inside scoreboard */
    #scoreboard ul {
      padding-left: 20px;
      margin: 0;
    }
    /* Player selection buttons */
    .player-btn {
      margin: 5px 5px 5px 0;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #ccc;
      border: none;
      border-radius: 4px;
      transition: 0.3s ease;
      user-select: none;
    }
    /* Selected player button style */
    .player-btn.selected {
      background-color: #0044cc;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 5px #0044cc;
    }
    /* Edit and delete buttons for commands */
    .edit-btn, .delete-btn {
      float: right;
      font-size: 0.8em;
      padding: 2px 6px;
      margin-left: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      user-select: none;
    }
    .edit-btn {
      background-color: #faa;
    }
    .delete-btn {
      background-color: #fcc;
    }
    /* Toggle command list button */
    #toggleCommandList {
      margin-top: 10px;
      cursor: pointer;
      background: #ddd;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      user-select: none;
      width: auto;
    }
    /* Dark mode toggle button */
    #darkModeToggle {
      margin-bottom: 10px;
      cursor: pointer;
      background: #666;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      user-select: none;
      width: auto;
    }
    /* Rounds and start score input styling */
    #roundsSection, #startScoreSection {
      margin-top: 20px;
    }
  </style>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Dark mode toggle button -->
  <button id="darkModeToggle">Toggle Dark Mode</button>

  <!-- Players management section -->
  <div id="playersSection">
    <h2>Players</h2>
    <input id="newPlayerName" placeholder="Enter player name" />
    <button onclick="addPlayer()">Add Player</button>
    <div id="playerButtons"></div>
  </div>

  <!-- Rounds input section -->
  <div id="roundsSection">
    <label for="numRounds">Number of rounds to play:</label>
    <input type="number" id="numRounds" value="10" min="1" max="100" />
  </div>

  <!-- Starting score input -->
  <div id="startScoreSection">
    <label for="startingScore">Starting score for each player:</label>
    <input type="number" id="startingScore" value="0" min="0" max="10000" />
  </div>

  <!-- Challenges toggle and list below players -->
  <button id="toggleCommandList">Toggle Challenge List</button>
  <div id="challengesSection">
    <div id="commandList"></div>
    <input id="newCommandText" placeholder="New challenge text" />
    <input id="newCommandDesc" placeholder="Optional description" />
    <button onclick="addCommand()">Add Challenge</button>
  </div>

  <!-- Game playing area -->
  <div id="gameArea" class="hidden">
    <div id="currentChallenge" class="commandBox"></div>
    <div id="challengeDescription" class="descriptionBox"></div>

    <!-- Score input and action buttons -->
    <input type="number" id="scoreInput" placeholder="Enter score for this challenge" min="0" />
    <button onclick="submitScore()">Submit Score</button>
    <button onclick="failChallenge()">Fail</button>
    <button onclick="undoLast()">Undo Last</button>
  </div>

  <!-- Scoreboard showing current scores -->
  <div id="scoreboard">
    <h3>Scoreboard</h3>
    <ul id="scoreList"></ul>
  </div>

<script>
  // Firebase configuration - replace with your own project config
  const firebaseConfig = {
    apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
    authDomain: "denchfield-half-it.firebaseapp.com",
    projectId: "denchfield-half-it",
    storageBucket: "denchfield-half-it.firebasestorage.app",
    messagingSenderId: "494344468882",
    appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
    measurementId: "G-ZQQM5PNWPV"
  };

  // Initialize Firebase app and Firestore database instance
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Global game variables
  let players = [];            // List of player objects { name, score }
  let selectedPlayers = [];    // Indexes of players selected for current game
  let commands = [];           // List of challenges from Firestore
  let currentRound = 1;        // Current round number in game
  let numRounds = 10;          // Total rounds to play (user input)
  let currentChallengeIndex = 0; // Index of current challenge in commands array
  let currentPlayerIndex = 0;     // Index of current player turn
  let scoreHistory = [];       // Stack for undo functionality (stores previous scores and states)
  let gameInProgress = false;  // Flag for whether a game is currently running
  let hardcoreUsed = false;    // Flag whether hardcore challenge has been used this game

  /** 
   * Load all challenges from Firestore and display them with edit/delete options 
   */
  function loadCommands() {
    commands = [];
    const listDiv = document.getElementById("commandList");
    listDiv.innerHTML = ""; // Clear existing list

    db.collection("commands").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const cmd = { id: doc.id, text: data.text, description: data.description || "", hardcore: data.hardcore || false };
        commands.push(cmd);

        // Create div for each challenge
        const div = document.createElement("div");
        div.innerHTML = `<strong>${cmd.text}</strong><br/><em>${cmd.description}</em>`;

        // Edit button for this challenge
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "edit-btn";
        editBtn.onclick = () => editCommand(cmd);

        // Delete button for this challenge
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = () => deleteCommand(cmd.id);

        div.appendChild(editBtn);
        div.appendChild(deleteBtn);

        listDiv.appendChild(div);
      });
    });
  }

  /**
   * Add a new challenge to Firestore based on user input
   */
  function addCommand() {
    const text = document.getElementById("newCommandText").value.trim();
    const description = document.getElementById("newCommandDesc").value.trim();
    if (!text) {
      alert("Challenge text cannot be empty.");
      return;
    }
    db.collection("commands").add({ text, description }).then(() => {
      loadCommands(); // Reload list after adding
      document.getElementById("newCommandText").value = "";
      document.getElementById("newCommandDesc").value = "";
    });
  }

  /**
   * Edit an existing challenge - prompts user for new text and description
   * @param {object} cmd - Challenge object to edit
   */
  function editCommand(cmd) {
    const newText = prompt("Edit challenge text:", cmd.text);
    if (newText === null) return; // Cancelled

    const newDesc = prompt("Edit description:", cmd.description);
    if (newDesc === null) return; // Cancelled

    db.collection("commands").doc(cmd.id).set({ text: newText.trim(), description: newDesc.trim() }).then(loadCommands);
  }

  /**
   * Delete a challenge by its Firestore document ID after user confirmation
   * @param {string} id - Firestore doc id of challenge to delete
   */
  function deleteCommand(id) {
    if (confirm("Delete this challenge?")) {
      db.collection("commands").doc(id).delete().then(loadCommands);
    }
  }

  /**
   * Add a new player to the player list and update UI
   */
  function addPlayer() {
    const input = document.getElementById("newPlayerName");
    const name = input.value.trim();
    if (!name) {
      alert("Player name cannot be empty.");
      return;
    }
    players.push({ name: name, score: 0 });
    input.value = "";
    renderPlayerButtons();
  }

  /**
   * Render buttons for each player allowing selection/deselection
   */
  function renderPlayerButtons() {
    const container = document.getElementById("playerButtons");
    container.innerHTML = ""; // Clear existing buttons
    players.forEach((player, index) => {
      const btn = document.createElement("button");
      btn.textContent = player.name;
      btn.className = "player-btn";
      if (selectedPlayers.includes(index)) {
        btn.classList.add("selected");
      }
      btn.onclick = () => {
        togglePlayerSelection(index);
      };
      container.appendChild(btn);
    });
  }

  /**
   * Toggle selection/deselection of a player by index
   * @param {number} index - Player index to toggle
   */
  function togglePlayerSelection(index) {
    const pos = selectedPlayers.indexOf(index);
    if (pos === -1) {
      selectedPlayers.push(index);
    } else {
      selectedPlayers.splice(pos, 1);
    }
    renderPlayerButtons();
  }

  /**
   * Start a new game with current selected players, rounds and starting score
   */
  function startGame() {
    if (selectedPlayers.length === 0) {
      alert("Please select at least one player.");
      return;
    }
    numRounds = parseInt(document.getElementById("numRounds").value, 10);
    if (isNaN(numRounds) || numRounds < 1) {
      alert("Please enter a valid number of rounds.");
      return;
    }
    const startScoreInput = parseInt(document.getElementById("startingScore").value, 10);
    const startScore = isNaN(startScoreInput) ? 0 : startScoreInput;

    // Initialize player scores
    selectedPlayers.forEach(idx => {
      players[idx].score = startScore;
    });

    currentRound = 1;
    currentPlayerIndex = 0;
    currentChallengeIndex = 0;
    scoreHistory = [];
    gameInProgress = true;
    hardcoreUsed = false;

    // Hide setup UI and show game UI
    document.getElementById("gameArea").classList.remove("hidden");
    document.getElementById("playersSection").classList.add("hidden");
    document.getElementById("roundsSection").classList.add("hidden");
    document.getElementById("startScoreSection").classList.add("hidden");
    document.getElementById("challengesSection").classList.add("hidden");
    document.getElementById("toggleCommandList").classList.add("hidden");

    updateDisplay();
  }

  /**
   * Update the main game display: current player, challenge, scores, round info
   */
  function updateDisplay() {
    // Show current challenge with hardcore indication
    const challenge = commands[currentChallengeIndex];
    const currentChallengeDiv = document.getElementById("currentChallenge");
    currentChallengeDiv.textContent = challenge ? challenge.text : "No challenge available";

    // Apply styles for current and hardcore challenge
    currentChallengeDiv.className = "commandBox current";
    if (challenge && isHardcoreChallenge(currentChallengeIndex)) {
      currentChallengeDiv.classList.add("hardcore");
    }

    // Show challenge description if any
    const descDiv = document.getElementById("challengeDescription");
    descDiv.textContent = challenge && challenge.description ? challenge.description : "";

    // Update scoreboard with selected players and their scores
    const scoreList = document.getElementById("scoreList");
    scoreList.innerHTML = "";
    selectedPlayers.forEach(idx => {
      const li = document.createElement("li");
      li.textContent = `${players[idx].name}: ${players[idx].score}`;
      // Highlight current player's name
      if (idx === selectedPlayers[currentPlayerIndex]) {
        li.style.fontWeight = "bold";
        li.style.color = "#0044cc";
      }
      scoreList.appendChild(li);
    });
  }

  /**
   * Check if a given challenge index should be a hardcore challenge
   * Rules: only once every 10 challenges, never on last challenge
   * @param {number} idx - challenge index
   * @returns {boolean} whether challenge is hardcore for this round
   */
  function isHardcoreChallenge(idx) {
    // If hardcore already used in this game, disable others
    if (hardcoreUsed) return false;
    // Never last challenge
    if (idx === commands.length - 1) return false;
    // Every 10th challenge (starting at index 9, 19, 29, etc.)
    return (idx + 1) % 10 === 0;
  }

  /**
   * Submit a score for the current challenge and player,
   * advances turn/round, and handles hardcore challenge failure logic
   */
  function submitScore() {
    if (!gameInProgress) return alert("Start the game first!");

    const scoreInput = document.getElementById("scoreInput");
    let score = parseInt(scoreInput.value, 10);
    if (isNaN(score) || score < 0) {
      alert("Enter a valid non-negative score.");
      return;
    }

    const currentPlayer = selectedPlayers[currentPlayerIndex];
    const currentChallenge = commands[currentChallengeIndex];
    // Save state for undo
    scoreHistory.push({
      round: currentRound,
      playerIndex: currentPlayerIndex,
      challengeIndex: currentChallengeIndex,
      players: JSON.parse(JSON.stringify(players)),
      hardcoreUsed: hardcoreUsed
    });

    // Add score to player
    players[currentPlayer].score += score;

    // If this was a hardcore challenge, mark hardcoreUsed
    if (isHardcoreChallenge(currentChallengeIndex)) {
      hardcoreUsed = true;
    }

    advanceTurn();
    scoreInput.value = "";
  }

  /**
   * Handle failing the current challenge:
   * - For hardcore challenge, player's score resets to 0
   * - For normal challenge, no score change
   * Then advance turn/round
   */
  function failChallenge() {
    if (!gameInProgress) return alert("Start the game first!");

    const currentPlayer = selectedPlayers[currentPlayerIndex];
    const currentChallenge = commands[currentChallengeIndex];
    // Save state for undo
    scoreHistory.push({
      round: currentRound,
      playerIndex: currentPlayerIndex,
      challengeIndex: currentChallengeIndex,
      players: JSON.parse(JSON.stringify(players)),
      hardcoreUsed: hardcoreUsed
    });

    if (isHardcoreChallenge(currentChallengeIndex)) {
      players[currentPlayer].score = 0;
      hardcoreUsed = true;
    }
    // Else no score change for fail

    advanceTurn();
  }

  /**
   * Undo the last score or fail action by restoring previous state from history
   */
  function undoLast() {
    if (scoreHistory.length === 0) {
      alert("Nothing to undo.");
      return;
    }
    const lastState = scoreHistory.pop();

    currentRound = lastState.round;
    currentPlayerIndex = lastState.playerIndex;
    currentChallengeIndex = lastState.challengeIndex;
    players = lastState.players;
    hardcoreUsed = lastState.hardcoreUsed;

    updateDisplay();
  }

  /**
   * Advance to the next turn, challenge, and round as appropriate
   * Ends the game after all rounds are played
   */
  function advanceTurn() {
    // Move to next player
    currentPlayerIndex++;
    if (currentPlayerIndex >= selectedPlayers.length) {
      currentPlayerIndex = 0;
      // Next challenge only after all players finished current challenge
      currentChallengeIndex++;
      // Check for end of challenges or rounds
      if (currentChallengeIndex >= commands.length) {
        currentChallengeIndex = 0; // loop back if needed
      }

      // Increase round only when all challenges done for all players?
      // Here we'll advance round every time all players finished one challenge.
      currentRound++;
      if (currentRound > numRounds) {
        alert("Game over!");
        gameInProgress = false;
        showSetupUI();
        return;
      }
    }
    updateDisplay();
  }

  /**
   * Show the setup UI and hide the game area UI
   */
  function showSetupUI() {
    document.getElementById("gameArea").classList.add("hidden");
    document.getElementById("playersSection").classList.remove("hidden");
    document.getElementById("roundsSection").classList.remove("hidden");
    document.getElementById("startScoreSection").classList.remove("hidden");
    document.getElementById("challengesSection").classList.remove("hidden");
    document.getElementById("toggleCommandList").classList.remove("hidden");
  }

  /**
   * Toggles the visibility of the command list UI
   */
  document.getElementById("toggleCommandList").onclick = () => {
    const list = document.getElementById("commandList");
    if (list.style.display === "none" || list.style.display === "") {
      list.style.display = "block";
    } else {
      list.style.display = "none";
    }
  };

  /**
   * Toggles dark mode on/off by toggling body class
   */
  document.getElementById("darkModeToggle").onclick = () => {
    document.body.classList.toggle("dark");
  };

  // Load commands initially
  loadCommands();

  // Render players (empty at first)
  renderPlayerButtons();

  // For quick start, add a Start Game button below players
  const startBtn = document.createElement("button");
  startBtn.textContent = "Start Game";
  startBtn.onclick = startGame;
  document.getElementById("playersSection").appendChild(startBtn);
</script>
</body>
</html>

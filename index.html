<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Challenge Game</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; color: #333; margin: 0; padding: 1rem;}
  .dark-mode { background: #222; color: #eee; }
  button { margin: 0.25rem; padding: 0.5rem 1rem; cursor: pointer; }
  #playerButtons button.selected { background-color: #4CAF50; color: white; }
  #commandList { border: 1px solid #ccc; max-height: 200px; overflow-y: auto; margin-top: 0.5rem; }
  .delete-btn { margin-left: 0.5rem; background: #f44336; color: white; border: none; }
  .edit-btn { margin-left: 0.5rem; background: #2196F3; color: white; border: none; }
  #gameArea, #scoreboard, #historyArea, #gameOverPopup { margin-top: 1rem; }
  #gameArea.hidden, #scoreboard.hidden, #historyArea.hidden { display: none; }
  #gameOverPopup { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(0,0,0,0.75); display: none; justify-content: center; align-items: center; 
    color: white; 
  }
  #gameOverPopup > div { background: #333; padding: 2rem; border-radius: 8px; max-width: 300px; }
  #gameOverPopup button { background: #4CAF50; border: none; color: white; font-size: 1.2rem; margin-top: 1rem; width: 100%; }
  .hardcore { color: red; font-weight: bold; margin-left: 0.5rem; }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Challenge Game</h1>

<!-- Dark Mode Toggle -->
<button id="darkModeToggle">Toggle Dark Mode</button>

<!-- Player Management -->
<section>
  <h2>Players</h2>
  <input type="text" id="newPlayerName" placeholder="New player name" />
  <button id="addPlayerBtn">Add Player</button>
  <div id="playerButtons"></div>
</section>

<!-- Challenges Management -->
<section>
  <h2>Challenges</h2>
  <button id="toggleCommandList">Toggle Challenge List</button><br/>
  <input type="text" id="newCommandText" placeholder="Challenge text" />
  <input type="text" id="newCommandDesc" placeholder="Description (optional)" />
  <label><input type="checkbox" id="newCommandHardcore" /> Hardcore</label>
  <button id="addCommandBtn">Add Challenge</button>
  <div id="commandList"></div>
</section>

<!-- Game Settings -->
<section>
  <h2>Game Settings</h2>
  <label>Number of challenges per round: <input type="number" id="numChallengesInput" min="1" value="5" style="width:60px;" /></label><br/>
  <label><input type="checkbox" id="globalHardcoreToggle" /> Enable Global Hardcore Mode</label><br/>
  <button id="startGameBtn">Start Game</button>
</section>

<!-- Game Play Area -->
<section id="gameArea" class="hidden">
  <h2>Game In Progress</h2>
  <div id="currentPlayerName"></div>
  <div id="currentChallenge"></div>
  <div id="challengeDescription"></div>
  <label><input type="checkbox" id="challengeHardcoreOverride" disabled /> Hardcore Challenge</label><br/><br/>
  <input type="number" id="scoreInput" placeholder="Score" min="0" style="width: 100px;" />
  <button id="scoreBtn">Submit Score</button>
  <button id="failBtn">Fail Challenge</button>
  <button id="undoBtn">Undo Last Action</button>
</section>

<!-- Scoreboard -->
<section id="scoreboard" class="hidden">
  <h2>Scoreboard</h2>
  <ul id="scoreList"></ul>
</section>

<!-- History -->
<section id="historyArea" class="hidden">
  <h2>History</h2>
  <ul id="historyList"></ul>
</section>

<!-- Game Over Popup -->
<div id="gameOverPopup">
  <div>
    <h2>Game Over!</h2>
    <div id="finalResults"></div>
    <button id="closePopupBtn">Close</button>
  </div>
</div>

<script>
// === FIREBASE CONFIGURATION ===
// Replace with your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAusKA2YiJTelSm54EJfRbVJMk0M6mh_WM",
    authDomain: "denchfield-half-it.firebaseapp.com",
    projectId: "denchfield-half-it",
    storageBucket: "denchfield-half-it.firebasestorage.app",
    messagingSenderId: "494344468882",
    appId: "1:494344468882:web:7a1f0d2ac938627206e94b",
    measurementId: "G-ZQQM5PNWPV"
  };
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// === STATE VARIABLES ===
let players = [];
let commands = [];
let selectedPlayerIds = new Set();
let numChallengesPerGame = 5;
let globalHardcoreEnabled = false;

let gameStarted = false;
let gameChallengesOrder = [];
let currentChallengeIndex = 0;
let currentPlayerTurnIndex = 0;
let history = [];

// === DOM ELEMENTS ===
const playerButtonsDiv = document.getElementById("playerButtons");
const commandListDiv = document.getElementById("commandList");
const currentPlayerNameDiv = document.getElementById("currentPlayerName");
const currentChallengeDiv = document.getElementById("currentChallenge");
const challengeDescriptionDiv = document.getElementById("challengeDescription");
const challengeHardcoreOverrideCheckbox = document.getElementById("challengeHardcoreOverride");
const scoreInput = document.getElementById("scoreInput");
const scoreBtn = document.getElementById("scoreBtn");
const failBtn = document.getElementById("failBtn");
const undoBtn = document.getElementById("undoBtn");
const scoreboard = document.getElementById("scoreboard");
const scoreList = document.getElementById("scoreList");
const historyArea = document.getElementById("historyArea");
const historyList = document.getElementById("historyList");
const gameArea = document.getElementById("gameArea");
const newPlayerNameInput = document.getElementById("newPlayerName");
const addPlayerBtn = document.getElementById("addPlayerBtn");
const newCommandTextInput = document.getElementById("newCommandText");
const newCommandDescInput = document.getElementById("newCommandDesc");
const newCommandHardcoreCheckbox = document.getElementById("newCommandHardcore");
const addCommandBtn = document.getElementById("addCommandBtn");
const toggleCommandListBtn = document.getElementById("toggleCommandList");
const darkModeToggleBtn = document.getElementById("darkModeToggle");
const numChallengesInput = document.getElementById("numChallengesInput");
const globalHardcoreToggleCheckbox = document.getElementById("globalHardcoreToggle");
const startGameBtn = document.getElementById("startGameBtn");
const gameOverPopup = document.getElementById("gameOverPopup");
const finalResultsDiv = document.getElementById("finalResults");
const closePopupBtn = document.getElementById("closePopupBtn");

// === UTILS ===
function shuffleArray(array) {
  for (let i = array.length -1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// === FIRESTORE LOAD/SAVE ===

async function loadPlayers() {
  players = [];
  selectedPlayerIds.clear();
  playerButtonsDiv.innerHTML = "";
  const snapshot = await db.collection("players").get();
  snapshot.forEach(doc => {
    const p = { id: doc.id, ...doc.data() };
    p.score = p.score || 0;
    players.push(p);
  });
  players.sort((a,b) => a.name.localeCompare(b.name));
  renderPlayerButtons();
}

async function addPlayer(name) {
  if (!name.trim()) return alert("Player name cannot be empty.");
  const docRef = await db.collection("players").add({ name, score: 0 });
  players.push({ id: docRef.id, name, score: 0 });
  renderPlayerButtons();
  newPlayerNameInput.value = "";
}

async function deletePlayer(id) {
  if (!confirm("Delete this player?")) return;
  await db.collection("players").doc(id).delete();
  players = players.filter(p => p.id !== id);
  selectedPlayerIds.delete(id);
  renderPlayerButtons();
}

async function loadCommands() {
  commands = [];
  commandListDiv.innerHTML = "";
  const snapshot = await db.collection("commands").get();
  snapshot.forEach(doc => {
    const data = doc.data();
    commands.push({
      id: doc.id,
      text: data.text,
      description: data.description || "",
      hardcore: data.hardcore || false
    });
  });
  commands.sort((a,b) => a.text.localeCompare(b.text));
  renderCommandList();
}

async function addCommand(text, description, hardcore) {
  if (!text.trim()) return alert("Challenge text cannot be empty.");
  const docRef = await db.collection("commands").add({ text, description, hardcore });
  commands.push({ id: docRef.id, text, description, hardcore });
  renderCommandList();
  newCommandTextInput.value = "";
  newCommandDescInput.value = "";
  newCommandHardcoreCheckbox.checked = false;
}

async function deleteCommand(id) {
  if (!confirm("Delete this challenge?")) return;
  await db.collection("commands").doc(id).delete();
  commands = commands.filter(c => c.id !== id);
  renderCommandList();
}

async function editCommand(cmd) {
  const newText = prompt("Edit challenge text:", cmd.text);
  if (newText === null) return;
  const newDesc = prompt("Edit description:", cmd.description);
  if (newDesc === null) return;
  const hardcoreStr = prompt("Is hardcore? (yes/no)", cmd.hardcore ? "yes" : "no");
  const newHardcore = hardcoreStr && hardcoreStr.toLowerCase().startsWith("y");
  await db.collection("commands").doc(cmd.id).set({
    text: newText.trim(),
    description: newDesc.trim(),
    hardcore: newHardcore
  });
  await loadCommands();
}

// === RENDER FUNCTIONS ===

function renderPlayerButtons() {
  playerButtonsDiv.innerHTML = "";
  players.forEach(p => {
    const btn = document.createElement("button");
    btn.textContent = `${p.name} (${p.score})`;
    btn.className = "player-btn";
    if (selectedPlayerIds.has(p.id)) btn.classList.add("selected");
    btn.onclick = () => {
      if (selectedPlayerIds.has(p.id)) {
        selectedPlayerIds.delete(p.id);
        btn.classList.remove("selected");
      } else {
        selectedPlayerIds.add(p.id);
        btn.classList.add("selected");
      }
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "✕";
    delBtn.className = "delete-btn";
    delBtn.title = "Delete player";
    delBtn.onclick = (e) => {
      e.stopPropagation();
      deletePlayer(p.id);
    };

    btn.appendChild(delBtn);
    playerButtonsDiv.appendChild(btn);
  });
}

function renderCommandList() {
  commandListDiv.innerHTML = "";
  if (commands.length === 0) {
    commandListDiv.textContent = "No challenges added yet.";
    return;
  }
  commands.forEach(c => {
    const div = document.createElement("div");
    div.style.marginBottom = "0.5rem";

    const textSpan = document.createElement("span");
    textSpan.textContent = c.text;
    if (c.hardcore) {
      const hcSpan = document.createElement("span");
      hcSpan.textContent = " [Hardcore]";
      hcSpan.className = "hardcore";
      textSpan.appendChild(hcSpan);
    }
    div.appendChild(textSpan);

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "edit-btn";
    editBtn.onclick = () => editCommand(c);
    div.appendChild(editBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.className = "delete-btn";
    delBtn.onclick = () => deleteCommand(c.id);
    div.appendChild(delBtn);

    commandListDiv.appendChild(div);
  });
}

function renderScoreboard() {
  scoreList.innerHTML = "";
  const playingPlayers = players.filter(p => selectedPlayerIds.has(p.id));
  playingPlayers.sort((a,b) => b.score - a.score);
  playingPlayers.forEach(p => {
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.score}`;
    scoreList.appendChild(li);
  });
}

function renderHistory() {
  historyList.innerHTML = "";
  history.forEach(h => {
    const p = players.find(pl => pl.id === h.playerId);
    const c = commands.find(cmd => cmd.id === h.commandId);
    const li = document.createElement("li");
    li.textContent = `${p ? p.name : "Unknown"} - "${c ? c.text : "Unknown Challenge"}" - `;
    li.textContent += h.fail ? "Failed" : `Score: ${h.score}`;
    if (h.hardcore) li.textContent += " (Hardcore)";
    historyList.appendChild(li);
  });
}

// === GAME LOGIC ===

function resetScores() {
  players.forEach(p => {
    p.score = 0;
  });
}

function prepareGameChallenges() {
  // Select numChallengesPerGame random challenges from commands
  gameChallengesOrder = commands.slice();
  shuffleArray(gameChallengesOrder);
  if (numChallengesPerGame > gameChallengesOrder.length) {
    numChallengesPerGame = gameChallengesOrder.length;
    numChallengesInput.value = numChallengesPerGame;
  }
  gameChallengesOrder = gameChallengesOrder.slice(0, numChallengesPerGame).map(c => c.id);

  currentChallengeIndex = 0;
  currentPlayerTurnIndex = 0;
}

function getCurrentPlayer() {
  const playingPlayers = players.filter(p => selectedPlayerIds.has(p.id));
  if (playingPlayers.length === 0) return null;
  return playingPlayers[currentPlayerTurnIndex % playingPlayers.length];
}

function getCurrentChallenge() {
  if (currentChallengeIndex >= gameChallengesOrder.length) return null;
  const cmdId = gameChallengesOrder[currentChallengeIndex];
  return commands.find(c => c.id === cmdId);
}

function showCurrentTurn() {
  const player = getCurrentPlayer();
  const challenge = getCurrentChallenge();
  if (!player || !challenge) {
    currentPlayerNameDiv.textContent = "No active player or challenge.";
    currentChallengeDiv.textContent = "";
    challengeDescriptionDiv.textContent = "";
    challengeHardcoreOverrideCheckbox.checked = false;
    challengeHardcoreOverrideCheckbox.disabled = true;
    return;
  }
  currentPlayerNameDiv.textContent = `Current Player: ${player.name}`;
  currentChallengeDiv.textContent = challenge.text;
  challengeDescriptionDiv.textContent = challenge.description || "";
  challengeHardcoreOverrideCheckbox.checked = globalHardcoreEnabled && challenge.hardcore;
  challengeHardcoreOverrideCheckbox.disabled = true;
}

function advanceTurn() {
  currentPlayerTurnIndex++;
  const playingPlayers = players.filter(p => selectedPlayerIds.has(p.id));
  if (currentPlayerTurnIndex >= playingPlayers.length) {
    currentPlayerTurnIndex = 0;
    currentChallengeIndex++;
  }
  if (currentChallengeIndex >= gameChallengesOrder.length) {
    endGame();
    return;
  }
  showCurrentTurn();
  scoreInput.value = "";
}

function endGame() {
  gameStarted = false;
  gameArea.classList.add("hidden");
  scoreboard.classList.remove("hidden");
  historyArea.classList.remove("hidden");

  let resultHTML = "<ol>";
  const playingPlayers = players.filter(p => selectedPlayerIds.has(p.id));
  playingPlayers.sort((a,b) => b.score - a.score);
  playingPlayers.forEach(p => {
    resultHTML += `<li>${p.name}: ${p.score}</li>`;
  });
  resultHTML += "</ol>";
  finalResultsDiv.innerHTML = resultHTML;
  gameOverPopup.style.display = "flex";
}

function submitScore() {
  if (!gameStarted) return alert("Game is not started.");
  const player = getCurrentPlayer();
  const challenge = getCurrentChallenge();
  if (!player || !challenge) return alert("No active player or challenge.");
  let scoreVal = parseInt(scoreInput.value);
  if (isNaN(scoreVal) || scoreVal < 0) return alert("Enter a valid positive score.");

  player.score += scoreVal;

  history.push({
    playerId: player.id,
    commandId: challenge.id,
    score: scoreVal,
    fail: false,
    hardcore: challengeHardcoreOverrideCheckbox.checked
  });

  renderScoreboard();
  renderHistory();
  advanceTurn();
}

function failChallenge() {
  if (!gameStarted) return alert("Game is not started.");
  const player = getCurrentPlayer();
  const challenge = getCurrentChallenge();
  if (!player || !challenge) return alert("No active player or challenge.");

  const isHardcore = challengeHardcoreOverrideCheckbox.checked;

  if (isHardcore) {
    player.score = 0;
  } else {
    player.score = Math.floor(player.score / 2);
  }

  history.push({
    playerId: player.id,
    commandId: challenge.id,
    score: 0,
    fail: true,
    hardcore: isHardcore
  });

  renderScoreboard();
  renderHistory();
  advanceTurn();
}

function undoLastAction() {
  if (history.length === 0) return alert("Nothing to undo.");
  const last = history.pop();
  const player = players.find(p => p.id === last.playerId);
  if (!player) return alert("Player not found for undo.");

  if (last.fail) {
    if (last.hardcore) {
      alert("Cannot undo hardcore fail.");
      history.push(last);
      return;
    } else {
      player.score = player.score * 2;
    }
  } else {
    player.score -= last.score;
    if (player.score < 0) player.score = 0;
  }

  // Rewind turn
  const playingPlayers = players.filter(p => selectedPlayerIds.has(p.id));
  if (currentPlayerTurnIndex === 0) {
    currentPlayerTurnIndex = playingPlayers.length - 1;
    currentChallengeIndex = Math.max(currentChallengeIndex - 1, 0);
  } else {
    currentPlayerTurnIndex--;
  }

  renderScoreboard();
  renderHistory();
  showCurrentTurn();
}

// === EVENT LISTENERS ===

addPlayerBtn.onclick = () => addPlayer(newPlayerNameInput.value);

addCommandBtn.onclick = () => addCommand(newCommandTextInput.value, newCommandDescInput.value, newCommandHardcoreCheckbox.checked);

toggleCommandListBtn.onclick = () => {
  if (commandListDiv.style.display === "none" || commandListDiv.style.display === "") {
    commandListDiv.style.display = "block";
  } else {
    commandListDiv.style.display = "none";
  }
};

darkModeToggleBtn.onclick = () => {
  document.body.classList.toggle("dark-mode");
};

numChallengesInput.onchange = (e) => {
  let val = parseInt(e.target.value);
  if (isNaN(val) || val < 1) val = 1;
  numChallengesPerGame = val;
  e.target.value = val;
};

globalHardcoreToggleCheckbox.onchange = (e) => {
  globalHardcoreEnabled = e.target.checked;
};

startGameBtn.onclick = () => {
  if (selectedPlayerIds.size < 1) return alert("Select at least one player to start.");
  if (commands.length === 0) return alert("Add some challenges first.");
  numChallengesPerGame = parseInt(numChallengesInput.value) || 5;
  if (numChallengesPerGame > commands.length) numChallengesPerGame = commands.length;
  numChallengesInput.value = numChallengesPerGame;

  gameStarted = true;
  resetScores();
  prepareGameChallenges();
  history = [];

  gameArea.classList.remove("hidden");
  scoreboard.classList.remove("hidden");
  historyArea.classList.remove("hidden");

  renderScoreboard();
  renderHistory();
  showCurrentTurn();
};

scoreBtn.onclick = submitScore;
failBtn.onclick = failChallenge;
undoBtn.onclick = undoLastAction;

closePopupBtn.onclick = () => {
  gameOverPopup.style.display = "none";
  // Reset for next game
  gameArea.classList.add("hidden");
  scoreboard.classList.add("hidden");
  historyArea.classList.add("hidden");
};

// === INITIAL LOAD ===
loadPlayers();
loadCommands();
commandListDiv.style.display = "none"; // Hide challenge list initially
scoreboard.classList.add("hidden");
historyArea.classList.add("hidden");
gameArea.classList.add("hidden");
</script>

</body>
</html>
